/*!
* things. it's so thingy.
* v0.0.1 @stephenplusplus 3/19/13
* github.com/stephenplusplus/things
*/
(function(e){"use strict";var n={}.toString,t=function(e,n){return typeof e===n},r=function(e){return!i(e)},i=function(e){return t(e,"undefined")},o=function(e){return"[object Function]"===n.call(e)},u=function(e){return"[object Array]"===n.call(e)},c=function(n){var t=o(n),c=Array.prototype.forEach,a=function(e){return r(e)?e.querySelectorAll.bind(e):void 0};return function(){var d={matches:null,find:function(e){var n,t=a(d.matches[0]);return o(t)&&(n=t(e)),r(n)&&r(n[0])&&(d.matches=n),d},html:function(e){return i(e)?d.matches[0].innerHTML:(o(e)||u(e)||c.call(d.matches,function(n){return n.innerHTML=e}),void 0)}};return t?n(arguments[0]):(d.matches=a(e.document)(arguments[0]),d)}}(e.jQuery),a=["route","service","thing"],d={},s={},v=function(e,n){var t=c('[data-route="'+n+'"]'),i=t.find("[data-el]");e.route[n].__dataroute=t,e.route[n].__datael=r(i[0])?i:t},f=function(e,n){return v(e,n),e.route[n].__datael},p=function(e,n){e.__incomingRoute=n,e.__requestingType="route",l(e,n,"route"),e.__activeRoute=n},_=function(e,n,t,r){if("service"===n&&!o(r)&&i(e.service[t].__invoked))throw Error("Services must be functions!");if(e[n][t]=r,o(r)){var u=(""+r).match(/^\s*function\s*\((.*?)\)/);e[n][t].__dependencies=u&&""!==u[1]?u[1].replace(/\s/g,"").split(","):[]}"service"===n&&i(e.service[t].__invoked)&&(e.service[t].__invoked=!1)},y=function(e,n,t){var o={dependencyType:void 0,dependency:void 0};if(i(n)&&i(t))return o;if(r(n)&&r(t)?(o.dependencyType=t,o.dependency=e[t][n]):o.dependency=a.filter(function(t){return r(e[t][n])?(o.dependencyType=t,e[t][n]):void 0})[0],!o.dependency||!o.dependencyType)throw Error(n+" doesn't appear to be a thing.");return o},l=function(e,n,t){if(i(n)||i(t))return void 0;var r=e.__invokingFilter(n,t),c=e[t][n].__dependencies,a=r.preInstantiation();return u(c)&&(e.__requestingType=t),o(a)&&!e[t][n].__invoked&&(a=new a(l(e,c[0],y(e,c[0]).dependencyType),l(e,c[1],y(e,c[1]).dependencyType),l(e,c[2],y(e,c[2]).dependencyType),l(e,c[3],y(e,c[3]).dependencyType),l(e,c[4],y(e,c[4]).dependencyType),l(e,c[5],y(e,c[5]).dependencyType),l(e,c[6],y(e,c[6]).dependencyType),l(e,c[7],y(e,c[7]).dependencyType),l(e,c[8],y(e,c[8]).dependencyType),l(e,c[9],y(e,c[9]).dependencyType))),r.postInstantiation(a)},h=function(e){var n={boot:function(){return this.value},route:function(){return this.name!==e.__incomingRoute&&(this.value="Routes cannot be dependencies, sorry!"),this.value},service:function(){return this.value},thing:function(){return"$el"===this.name&&"route"===e.__requestingType&&e.__incomingRoute!==e.__activeRoute&&(this.value=f(e,e.__incomingRoute)),this.value}},t={boot:function(e){return e},route:function(e){return e},service:function(n){return _(e,"service",this.name,n),e.service[this.name].__invoked=!0,n},thing:function(e){return e}};e.__invokingFilter=function(r,i){var o={name:r,value:y(e,r,i).dependency};return{preInstantiation:n[i].bind(o),postInstantiation:t[i].bind(o)}}};e.things=function(){var n=function(n){if(i(n))throw Error("Hey! Name your things!");var t=s[n];if(r(t))return t;var u=d[n]={__invokingFilter:null,__incomingRoute:null,__activeRoute:null,route:{},service:{},thing:{},boot:{}};h(u),_(u,"thing","root",window),_(u,"service","goTo",function(){return v}),_(u,"service","$",function(){return c}),_(u,"thing","$el",c);var a=function(e){return function(t,r){return _(u,e,t,r),s[n]}},v=function(e){return p(u,e),s[n]},f=function(e){if(o(e)){var t=(""+e).substr(10,30).replace(/[^\w]|\s/g,"");return _(u,"boot",t,e),y&&l(u,t,"boot"),s[n]}},y="complete"===document.readyState;return e.onload=function(){y=!0;for(var e in u.boot)u.boot.hasOwnProperty(e)&&l(u,e,"boot")},s[n]={route:a("route"),service:a("service"),thing:a("thing"),goTo:v,boots:f}};return n}()})(window);